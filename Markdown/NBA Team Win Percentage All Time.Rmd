---
title: "Win Percent Change Over Time"
author: "Ryan Harrington"
output: 
  html_document:
    theme: yeti
    highlight: textmate
    toc: TRUE
    toc_float: TRUE
    df_print: paged
    code_folding: hide
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
Necessary libraries are loaded in

```{r libraries, message = FALSE, warning = FALSE, error = FALSE}

if (! require("pacman")) install.packages("pacman")

if (! require("gganimate")) devtools::install_github('thomasp85/gganimate')

pacman::p_load(
  tidyverse
  ,rvest
  ,readr
  ,plotly
  ,gganimate
  ,gifski
  ,glue
  )

theme_set(theme_minimal())

```

## Functions

### Get Team Abbreviations

```{r}

team_urls <- "https://www.basketball-reference.com/teams/"
team_webpage <- read_html(team_urls)

```

```{r}

teams <- 
  team_webpage %>%
  html_nodes("#teams_active") %>%
  html_table() %>%
  as.data.frame()

team_abbreviation_list <-
  team_webpage %>%
  html_nodes("#teams_active  a") %>%
  html_attrs() %>%
  as.list() %>%
  str_extract("[A-Z]{3}")

```

```{r}
get_league_teams <- function(years) {
  
  urls <- NULL
  
  for (year in years) {
    
    league_url <- paste0("https://www.basketball-reference.com/leagues/NBA_", year, ".html")
    
    webpage_check <- try(
      league_webpage <- read_html(league_url)
    )
    
    urls_temp <- 
      league_webpage %>% 
      html_nodes("table a") %>% 
      html_attrs() %>% 
      as.list() %>% 
      unlist() %>% 
      unname() %>% 
      unique()
    
    urls[[length(urls) + 1]] <- urls_temp
    
  }  
  
  urls <-
    urls %>% 
    unlist()
  
  return(urls)
  
}
```

### Get Team Games

```{r}

get_team_games <- function(teams_df = as.data.frame()) {
  
  team_year_games <- NULL
  total_teams     <- nrow(teams_df)
  start_time      <- Sys.time()
  
  for(i in 1:total_teams) {
    
    team <- teams_df$Team[i]
    year <- teams_df$Year[i]
    
    # Build URL
    team_year_url <- paste0("https://www.basketball-reference.com/teams/",
                            team,"/", year, "_games.html")
    
    # Extract HTML from URL
    webpage_check <- try(
      team_year <- read_html(team_year_url)
    )
    
    # Extract Table from URL
    if (class(webpage_check)[1] != "try-error") {
      
      games_table_check <- try(
        team_year_games_temp <- 
          team_year %>%
          html_nodes("#games") %>%
          html_table() %>%
          as.data.frame()
      )
      
      # Manipulate extracted table
      if (class(games_table_check)[1] != "try-error") {
        
        manipulation_check <- try(
          team_year_games_temp <- 
            team_year_games_temp %>%
            filter(G != "G") %>%
            select("G" = G, "Date" = Date, "StartTime" = Start..ET., 
                   "Home" = Var.6, "Opponent" = Opponent, 
                   "Win" = Var.8,"TeamScore" = Tm, "OppScore" = Opp, 
                   "TotalWins" = W, "TotalLosses" = L, "Streak" = Streak) %>%
            mutate(Date = str_remove(Date, "^[A-Za-z]{3}, "),
                   Date = as.Date(Date, format = "%b %d, %Y"),
                   StartTime = str_replace(StartTime,"p",""),
                   StartTime = paste0(as.numeric(str_extract(StartTime, "^[0-9]{1,2}")) + 12,
                                      str_extract(StartTime,":[0-9]{2}")),
                   Date = as.POSIXct(paste(Date, StartTime)),
                   Home = as.factor(if_else(Home != "@", 1, 0)),
                   Win = as.factor(if_else(Win == "W", 1, 0)),
                   TeamScore = as.numeric(TeamScore),
                   OppScore = as.numeric(OppScore),
                   TotalWins = as.numeric(TotalWins),
                   TotalLosses = as.numeric(TotalLosses),
                   WinPercent = TotalWins / (TotalWins + TotalLosses),
                   Team = team,
                   Season = year) %>%
            select(-StartTime, Team, Season, everything())
        )        
        
        if (class(manipulation_check)[1] != "try-error") {
          # Create a data frame
          # assign(paste0("game_log.", team_abbreviation_list[i], years[j]))
          
          # Join the temp table to the real table
          team_year_games <- rbind(team_year_games, team_year_games_temp)
          # print(game_log_table)
          
          elapsed_time <- difftime(Sys.time(), start_time,
                                   units = "mins")
          
          message(cat(paste0(year, " | ", team, "\n",
                             i, " of ", total_teams, " teams \n",
                             "Elapsed: ", round(elapsed_time, 3), " minutes \n")))
          
          # Sleep for a bit
          sleep_time <- runif(1) + 2
          Sys.sleep(time = sleep_time)
          
        }        
      }      
      
    }      
    
  }
  
  return(team_year_games)
  
}

```

# Get Data

```{r}
team_urls <- get_league_teams(years = 1950:2020)
```

```{r}
teams <- 
  data.frame(Team_URL = team_urls) %>% 
  mutate(Team = str_extract(Team_URL, "[A-Z]+"),
         Year = str_extract(Team_URL, "[0-9]+")) %>% 
  select(Team, Year, Team_URL)
```

```{r}
team_games <-
  get_team_games(teams_df = teams)
```

```{r}
write_csv(team_games, here::here("Data", "team_games_1950_2020.csv"))
team_games <- read_csv(here::here("Data", "team_games_1950_2020.csv"))
```

```{r}
wins_comparison <- 
  team_games %>% 
  add_count(Team, Season, name = "TotalGames") %>% 
  filter(TotalGames == 82) %>% 
  group_by(Team, Season) %>% 
  mutate(FinalWins = max(TotalWins)) %>% 
  ungroup() %>% 
  mutate(WinPercentFinal = FinalWins / TotalGames,
         G = as.numeric(G)) %>% 
  select(G, Team, Season, WinPercent, WinPercentFinal)
```

```{r}
# anim <- 
  wins_comparison %>% 
  filter(! is.na(WinPercentFinal)) %>% 
  ggplot(aes(x = WinPercent,
             y = WinPercentFinal)) +
  geom_point(alpha = 0.75) +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  # labs(title = "Game {G} of 82",
  #      x     = "Win % after game {G}",
  #      y     = "Win % after game 82") +
  transition_time(G) +
  enter_fade() + 
  exit_shrink() +
  ease_aes('sine-in-out')

# anim_save(here::here("Visualizations", "current_vs_final_win_percent_by_game.gif"),
#           anim)
```

```{r}
wins_comparison %>% 
  filter(! is.na(WinPercentFinal)) %>% 
  mutate(WinPercentDiff = WinPercentFinal - WinPercent) %>% 
  ggplot(aes(x = WinPercentDiff)) +
  geom_histogram(binwidth = 0.1,
                 center = 0) +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::comma) +
  # labs(title = "Game {G} of 82",
  #      x     = "Win % after game {G}",
  #      y     = "Win % after game 82") +
  transition_time(G) +
  enter_fade() + 
  exit_shrink() +
  ease_aes('sine-in-out')
```

```{r}
wins_comparison %>% 
  filter(! is.na(WinPercentFinal)) %>% 
  mutate(WinPercentDiff = WinPercentFinal - WinPercent) %>% 
  ggplot(aes(x = WinPercent,
             y = WinPercentDiff,
             color = WinPercentFinal)) +
  geom_point(alpha = 0.75) +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  labs(title = glue("Game {G} of 82"),
       x     = glue("Win % after game {G}"),
       y     = glue("Win % after game 82")) +
  transition_time(G) +
  enter_fade() + 
  exit_shrink() +
  ease_aes('sine-in-out')
```

